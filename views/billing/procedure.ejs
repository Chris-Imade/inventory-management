<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Billing - Procedure - Health Haven</title>
  <link rel="stylesheet" href="/css/styles.css">
  <script src="/js/lucide.js?v=1"></script>
  <style>
    .procedure-list { margin-top: 1rem; }
    .procedure-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid var(--neutral-200); border-radius: 8px; margin-bottom: 0.5rem; background: var(--neutral-50); }
    .procedure-search { position: relative; }
    .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--neutral-300); max-height: 200px; overflow-y: auto; z-index: 10; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .suggestion-item { padding: 0.75rem; cursor: pointer; border-bottom: 1px solid var(--neutral-200); }
    .suggestion-item:hover { background: var(--neutral-100); }
  </style>
</head>
<body>
  <div class="app-container">
    <%- include('../partials/sidebar', { activePage: 'billing' }) %>
    
    <main class="main-content">
      <div class="top-bar">
        <h1 class="page-title">Billing - Procedure</h1>
        <div class="flex items-center gap-md">
          <% if (typeof user !== 'undefined' && user) { %>
            <span class="text-muted" style="font-size: 0.875rem; display: flex; align-items: center; gap: 0.25rem;">
              <i data-lucide="user" class="icon icon-sm"></i><%= user %>
            </span>
          <% } %>
        </div>
      </div>

      <div class="content-wrapper">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Procedure Details</h2>
          </div>
          <div class="card-body">
            <form id="procedureForm">
              <input type="hidden" id="billId" value="<%= bill ? bill._id : '' %>">
              
              <div class="form-group procedure-search">
                <label for="procedureSearch">Search Procedure</label>
                <input type="text" id="procedureSearch" class="form-control" placeholder="Type to search procedures...">
                <div class="suggestions" id="procedureSuggestions"></div>
              </div>

              <div class="procedure-list" id="procedureList">
                <% if (bill && bill.procedures && bill.procedures.length > 0) { %>
                  <% bill.procedures.forEach((proc, index) => { %>
                    <div class="procedure-item" data-procedure-id="<%= proc.procedureId %>">
                      <div>
                        <strong><%= proc.procedureName %></strong>
                      </div>
                      <div style="display: flex; align-items: center; gap: 1rem;">
                        <input type="number" class="form-control" style="width: 150px;" value="<%= proc.price %>" min="0" step="0.01" data-price-input>
                        <button type="button" class="btn-icon" onclick="removeProcedure(this)">
                          <i data-lucide="trash-2" class="icon icon-sm"></i>
                        </button>
                      </div>
                    </div>
                  <% }); %>
                <% } %>
              </div>

              <div style="margin-top: 1rem; text-align: right;">
                <strong>Total Procedures: ₦<span id="totalProcedures">0.00</span></strong>
              </div>

              <div class="form-actions" style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary" onclick="window.location.href='/billing/drugs?billId=' + document.getElementById('billId').value">
                  <i data-lucide="arrow-left" class="icon icon-sm"></i>
                  Back
                </button>
                <button type="submit" class="btn btn-primary">
                  <i data-lucide="save" class="icon icon-sm"></i>
                  Save & Continue
                </button>
                <button type="button" class="btn btn-secondary" onclick="printBill('procedures')">
                  <i data-lucide="printer" class="icon icon-sm"></i>
                  Print Bill
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const procedureSearch = document.getElementById('procedureSearch');
    const procedureSuggestions = document.getElementById('procedureSuggestions');
    const procedureList = document.getElementById('procedureList');

    procedureSearch.addEventListener('input', async (e) => {
      const search = e.target.value;
      if (search.length < 2) {
        procedureSuggestions.style.display = 'none';
        return;
      }

      try {
        const response = await fetch(`/api/billing/procedures?search=${encodeURIComponent(search)}`);
        const data = await response.json();
        
        if (data.success && data.data.length > 0) {
          procedureSuggestions.innerHTML = data.data.map(proc => 
            `<div class="suggestion-item" data-procedure-id="${proc._id}" data-procedure-name="${proc.name}" data-price="${proc.standardPrice}">
              ${proc.name} - ₦${proc.standardPrice.toFixed(2)}
            </div>`
          ).join('');
          procedureSuggestions.style.display = 'block';

          procedureSuggestions.querySelectorAll('.suggestion-item').forEach(item => {
            item.addEventListener('click', () => {
              addProcedure(item.dataset.procedureId, item.dataset.procedureName, parseFloat(item.dataset.price));
              procedureSearch.value = '';
              procedureSuggestions.style.display = 'none';
            });
          });
        } else {
          procedureSuggestions.style.display = 'none';
        }
      } catch (error) {
        console.error('Error searching procedures:', error);
      }
    });

    document.addEventListener('click', (e) => {
      if (!procedureSearch.contains(e.target) && !procedureSuggestions.contains(e.target)) {
        procedureSuggestions.style.display = 'none';
      }
    });

    function addProcedure(id, name, price) {
      const existing = procedureList.querySelector(`[data-procedure-id="${id}"]`);
      if (existing) {
        alert('This procedure is already added');
        return;
      }

      const item = document.createElement('div');
      item.className = 'procedure-item';
      item.setAttribute('data-procedure-id', id);
      item.innerHTML = `
        <div>
          <strong>${name}</strong>
        </div>
        <div style="display: flex; align-items: center; gap: 1rem;">
          <input type="number" class="form-control" style="width: 150px;" value="${price}" min="0" step="0.01" data-price-input>
          <button type="button" class="btn-icon" onclick="removeProcedure(this)">
            <i data-lucide="trash-2" class="icon icon-sm"></i>
          </button>
        </div>
      `;
      procedureList.appendChild(item);
      
      item.querySelector('[data-price-input]').addEventListener('input', calculateTotal);
      
      lucide.createIcons();
      calculateTotal();
    }

    function removeProcedure(btn) {
      btn.closest('.procedure-item').remove();
      calculateTotal();
    }

    function calculateTotal() {
      const priceInputs = Array.from(document.querySelectorAll('[data-price-input]'));
      const total = priceInputs.reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
      document.getElementById('totalProcedures').textContent = total.toFixed(2);
    }

    document.getElementById('procedureForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const billId = document.getElementById('billId').value;
      if (!billId) {
        alert('Please complete previous sections first');
        window.location.href = '/billing/cards';
        return;
      }

      const procedureItems = Array.from(document.querySelectorAll('.procedure-item'));
      const procedures = procedureItems.map(item => ({
        procedureId: item.dataset.procedureId,
        procedureName: item.querySelector('strong').textContent,
        price: parseFloat(item.querySelector('[data-price-input]').value)
      }));

      try {
        const response = await fetch(`/api/billing/bills/${billId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ procedures }),
        });
        
        const data = await response.json();
        
        if (data.success) {
          window.location.href = `/billing/admission?billId=${billId}`;
        } else {
          alert('Error saving procedures');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error saving procedures');
      }
    });

    async function printBill(section) {
      const billId = document.getElementById('billId').value;
      if (!billId) {
        alert('Please save first');
        return;
      }
      
      try {
        const response = await fetch(`/api/billing/bills/${billId}/print?section=${section}`);
        const data = await response.json();
        
        if (data.success) {
          const printWindow = window.open('', '_blank');
          printWindow.document.write(generatePrintHTML(data.data));
          printWindow.document.close();
          printWindow.print();
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error printing bill');
      }
    }

    function generatePrintHTML(billData) {
      let html = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Bill - ${billData.billNumber}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { text-align: center; }
            .bill-header { margin-bottom: 20px; }
            .section { margin: 20px 0; }
            .section h3 { border-bottom: 2px solid #333; padding-bottom: 5px; }
            .item { display: flex; justify-content: space-between; padding: 5px 0; }
            .total { font-weight: bold; font-size: 1.2em; margin-top: 20px; text-align: right; }
          </style>
        </head>
        <body>
          <h1>Health Haven</h1>
          <div class="bill-header">
            <p><strong>Bill Number:</strong> ${billData.billNumber}</p>
            <p><strong>Patient:</strong> ${billData.patientName || 'N/A'}</p>
            <p><strong>Patient ID:</strong> ${billData.patientId || 'N/A'}</p>
            <p><strong>Date:</strong> ${new Date(billData.createdAt).toLocaleString()}</p>
          </div>
      `;
      
      billData.sections.forEach(section => {
        html += `<div class="section"><h3>${section.name}</h3>`;
        section.items.forEach(item => {
          html += `<div class="item"><span>${item.name}${item.details ? ' - ' + item.details : ''}</span><span>₦${item.price ? item.price.toFixed(2) : '0.00'}</span></div>`;
        });
        if (section.subtotal > 0) {
          html += `<div class="item" style="font-weight: bold;"><span>Subtotal:</span><span>₦${section.subtotal.toFixed(2)}</span></div>`;
        }
        html += `</div>`;
      });
      
      html += `<div class="total">TOTAL: ₦${billData.total.toFixed(2)}</div>`;
      html += `</body></html>`;
      
      return html;
    }

    calculateTotal();
    lucide.createIcons();
  </script>
</body>
</html>
